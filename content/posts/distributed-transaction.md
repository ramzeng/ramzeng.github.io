---
title: "分布式事务入门"
date: 2024-03-13T11:23:44+08:00
draft: true
tags: ["分布式", "面试"]
---
## 场景

![](https://cdn4.codesign.qq.com/materials/2024/03/13/GD5Oj24EPoJE03Z3eAX13/htgouvv8kgaslxpv/c7bf8afb-8726-4649-a32d-2b688cff01ae.png)

假设系统中有 3 个服务，分别是订单服务、账户服务、库存服务，用户下单之后会扣除用户的余额，同时扣减库存容量。在这样的场景下扣款和扣库存需要强一致性保证。就可能会使用到分布式事务解决方案。

## 分布式事务模型

各个服务之间必须能感知到彼此的事务状态，才能保证状态一致，因此需要引入一个全局事务协调者，来协调各个服务的事务状态。服务里的事务称为分支事务，全局事务包含多个分支事务。

### 名词解析

- 全局事务：整个分布式事务的执行单元，包含多个分支事务
- 分支事务：全局事务中的一个子事务单元，可以是本地事务，也可以是分布式事务
- 最终一致性：各分支事务分别执行并提交，如果有不一致的情况，通过补偿机制进行处理，最终达到一致的状态
- 强一致性：各分支事务执行完不提交，等待彼此结束，之后统一提交或回滚

## Seata 分布式事务架构

![](https://cdn4.codesign.qq.com/materials/2024/03/13/GD5Oj24EPoJE03Z3eAX13/htgouvv8kgaslxpv/d3f1871e-a164-4d4b-8a81-3320bd3eddf4.png)

### 重要角色

- TC（Transaction Coordinator）：事务协调器，维护全局和分支事务的状态，协调全局事务的提交和回滚
- TM（Transaction Manager）：事务管理器，定义全局事务的范围，开始全局事务、提交或回滚全局事务
- RM（Resource Manager）：资源管理器，管理分支事务处理的资源，与 TC 通信，注册分支事务和上报分支事务状态，驱动分支事务的提交和回滚

### 基本模型

1. TM 注册全局事务，业务调用各个微服务，由各自的 RM 向 TC 注册分支事务
2. 执行各个分支事务的 SQL 语句，完成后向 TC 上报事务状态
3. 所有分支事务执行完毕之后，TM 通知 TC 提交或回滚全局事务
4. TC 检查各个分支事务状态，决定提交或回滚全局事务，通知各个 RM 执行提交或回滚操作

### 解决方案

- XA：强一致性分阶段事务模式，牺牲可用性，无业务侵入
- TCC：最终一致的分阶段事务模式，有业务侵入
- AT：最终一致的分阶段事务模式，无业务侵入
- SAGA：长事务模式，有业务侵入

## XA 模式

XA 是一种分布式事务协议，由 XA 协议规范定义，是一种两阶段提交的分布式事务协议。XA 协议规范定义了事务管理器 TM 和资源管理器 RM 之间的通信协议。几乎所有主流的数据库都支持 XA 协议。

### 标准流程

- 第一阶段：准备阶段，TC 向 RM 发起 prepare 消息，RM 执行事务的预提交操作，然后返回结果给 TC
- 第二阶段：提交阶段，如果所有 RM 都返回 ready，TC 向 RM 发起 commit 消息，RM 执行事务的提交操作，然后返回结果给 TC

具体过程如下图所示：

正常流程：
![](https://cdn4.codesign.qq.com/materials/2024/03/14/GD5Oj24EPoJE03Z3eAX14/g0tpts249oijxw0c/0e9d81ad-51a9-4a5e-a841-465ff40aabb1.png)

异常流程：
![](https://cdn4.codesign.qq.com/materials/2024/03/14/GD5Oj24EPoJE03Z3eAX14/g0tpts249oijxw0c/978c19a5-d221-4489-b021-c3fb534d0186.png)

### Seata 流程

- RM 一阶段工作
  - 注册分支事务到 TC
  - 执行分支业务 SQL 但不提交
  - 上报状态到 TC
- TC 二阶段工作
  - 检测所有分支事务状态
  - 通知 RM 提交或回滚分支事务
- RM 二阶段工作
  - 根据 TC 的通知提交或回滚分支事务

![](https://cdn4.codesign.qq.com/materials/2024/03/14/GD5Oj24EPoJE03Z3eAX14/9obfzu3wuvkyygyg/7cf6f5e2-7020-4c59-bed5-6afcda65f016.png)

### 优势

1. 事务强一致性，满足 ACID 特性
2. 主流数据库都支持 XA 协议，实现简单，没有业务侵入

### 劣势

1. 一阶段需要锁定数据库资源，等待二阶段结束才能释放，性能较差
2. 依赖关系型数据库实现事务
