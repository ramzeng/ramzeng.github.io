---
title: "数据复制"
date: 2023-08-21T21:45:31+08:00
draft: false
tags: ["分布式"]
---
## 介绍
将同一份数据冗余存储在多个节点上，节点间通过网络同步数据，使之保持一致。一个存储了复制数据的节点称为副本。

## 作用
- 增强数据可用性和安全性
- 减少数据读取往返时间
- 提高数据吞吐量

## 主从复制
指定一个副本为主节点，写请求必须发给主节点，其余副本称为从节点，从节点只处理读请求，并从主节点同步数据。

主节点收到写请求，先将数据写入本地存储，再同步给所有从节点。

### 同步实现
- 同步操作日志
- 转发写请求

### 同步方式
- 同步复制：主节点收到写请求后，必须等待所有从节点同步成功后，才能返回响应
- 异步复制：主节点收到写请求后，立即返回响应，然后异步同步给从节点
- 半同步复制：主节点收到写请求后，等待至少一个从节点同步成功后，返回响应

### 优点
- 简单易懂，实现成本低
- 主节点处理写请求，能够保证操作顺序
- 读性能易于扩展，只需增加从节点

### 缺点
- 主节点成为瓶颈，写性能无法扩展
- 单点故障，主节点宕机，可能导致服务不可用

## 多主复制
多个节点处理写请求，提高写性能，但是可能会导致数据不一致，必须解决数据冲突问题。

### 冲突解决
- 客户端解决冲突：客户端获取所有数据，解决冲突后，再写入数据
- 最后写入胜利：基于时间戳或唯一自增 ID，选择最新版本的数据
- 因果关系跟踪：使用算法跟踪不同请求之间的因果关系

### 优点
- 主节点容错性高，一个主节点宕机，其他主节点仍然可用
- 写性能易于扩展，只需增加主节点

### 缺点
- 复杂性高，数据冲突难解决

## 无主复制
客户端向多个节点发送写请求，得到其中一些节点的响应，就认为写入成功。

### 数据修复
- 读修复：客户端从多个节点读取数据，检测旧数据节点，并更新旧节点的数据
- 反熵过程：独立服务修复数据，从存储最新数据的节点中将数据复制到错误节点

### 基于 Quorum 的数据冗余机制
保证一个由 N 个节点组成的集群中，要求至少成功写入 W 个节点，并且同时从 R 个节点读取数据。

只要满足 W + R > N 并且 W > N / 2，读取的 R 份数据中至少有一个是最新的。

> W > N / 2 主要保证数据的串形化修改，两个不同的写请求不能同时成功修改同一份数据。

可根据系统工作负载来配置 W 和 R 的值，W 越大 R 越小，读性能越高，反之写性能越高。
